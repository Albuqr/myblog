{
  "hash": "0d39de20e0f5625caeb1570657142aae",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"teste\"\nformat: \n  html:\n    embed-resources: true\njupyter: python3\nexecute:\n  echo: true\n  eval: true\n  warning: true\n  message: true\n---\n\nimport os\nimport requests\nfrom dotenv import load_dotenv\nimport folium\nimport webbrowser\n\nload_dotenv(\".env\")\nTOKEN = os.getenv(\"ONIBUS_TOKEN\")\nAPI = \"http://api.olhovivo.sptrans.com.br/v2.1\"\n\nlinha_usuario = \"2506\"\n\ns = requests.Session()\nres = s.post(f\"{API}/Login/Autenticar?token={TOKEN}\")\nprint(\"Autenticação:\", res.text)\n\ndef buscar_codigos(entrada):\n    termo = entrada.split(\"-\")[0]\n    r = s.get(f\"{API}/Linha/Buscar?termosBusca={termo}\")\n    dados = r.json()\n    print(\"\\nLinhas encontradas:\")\n    for d in dados:\n        print(d)\n    return [d[\"cl\"] for d in dados]\n\ndef buscar_itinerario(cod):\n    r = s.get(f\"{API}/Itinerario?codigoLinha={cod}\")\n    data = r.json()\n    traj = [[v[\"py\"], v[\"px\"]] for k, v in data.items() if k.isdigit()]\n    par = [{\"nome\": v[\"np\"], \"lat\": v[\"py\"], \"lng\": v[\"px\"]} for k, v in data.items() if k.startswith(\"p\")]\n    return traj, par\n\ndef buscar_posicao(cod):\n    r = s.get(f\"{API}/Posicao/Linha?codigoLinha={cod}\")\n    return r.json().get(\"vs\", [])\n\ntodos_codigos = buscar_codigos(linha_usuario)\n\nmelhor_trajeto = None\nmelhor_paradas = None\ncodigo_escolhido = None\n\nprint(\"\\nTestando códigos...\\n\")\n\nfor cod in todos_codigos:\n    traj, par = buscar_itinerario(cod)\n    print(f\"Código {cod} → Pontos: {len(traj)} / Paradas: {len(par)}\")\n    if len(traj) > 0:\n        melhor_trajeto = traj\n        melhor_paradas = par\n        codigo_escolhido = cod\n        break\n\nif melhor_trajeto is None:\n    print(\"\\nNenhum itinerário com trajeto. Testando paradas.\\n\")\n    for cod in todos_codigos:\n        r = s.get(f\"{API}/Parada/BuscarParadasPorLinha?codigoLinha={cod}\")\n        par = r.json()\n        if len(par) > 0:\n            melhor_paradas = [{\"nome\": p[\"np\"], \"lat\": p[\"py\"], \"lng\": p[\"px\"]} for p in par]\n            melhor_trajeto = []\n            codigo_escolhido = cod\n            print(f\"Usando paradas do código {cod}\")\n            break\n\nif melhor_paradas is None and melhor_trajeto is None:\n    raise Exception(\"API sem dados para essa linha.\")\n\nveiculos = buscar_posicao(codigo_escolhido)\nprint(f\"\\nVeículos encontrados: {len(veiculos)}\")\n\nif melhor_trajeto:\n    lat0, lng0 = melhor_trajeto[0]\nelse:\n    lat0, lng0 = melhor_paradas[0][\"lat\"], melhor_paradas[0][\"lng\"]\n\nm = folium.Map(location=[lat0, lng0], zoom_start=13)\n\nif melhor_trajeto:\n    folium.PolyLine(melhor_trajeto, weight=4, color=\"blue\").add_to(m)\n\nfor p in melhor_paradas:\n    folium.Marker(\n        [p[\"lat\"], p[\"lng\"]],\n        popup=p[\"nome\"],\n        icon=folium.Icon(color=\"green\")\n    ).add_to(m)\n\nfor v in veiculos:\n    folium.Marker(\n        [v[\"py\"], v[\"px\"]],\n        popup=f\"Prefixo: {v['p']}\",\n        icon=folium.Icon(color=\"red\")\n    ).add_to(m)\n\nm.save(\"onibus_mapa.html\")\nwebbrowser.open(\"onibus_mapa.html\")\n\nprint(\"\\nMapa gerado: onibus_mapa.\n\n",
    "supporting": [
      "teste_files"
    ],
    "filters": [],
    "includes": {}
  }
}