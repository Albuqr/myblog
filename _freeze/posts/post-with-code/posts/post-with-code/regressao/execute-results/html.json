{
  "hash": "6e4cd1c51841cc04dc3d942d417bc116",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Regressao Linear com Plotnine\"\ndescription: \"carrega dados de x e y, calcula regressao linear e gera grafico com plotnine\"\ndate: \"2025-02-01\"\nformat:\n  html:\n    embed-resources: true\njupyter: python3\nexecute:\n  echo: true\n  eval: true\n  warning: true\n  message: true\n---\n\n::: {#28a651b2 .cell execution_count=1}\n``` {.python .cell-code}\nimport os\nimport requests\nfrom io import StringIO\n\nimport numpy as np\nimport pandas as pd\nfrom dotenv import load_dotenv, find_dotenv\nfrom plotnine import ggplot, aes, geom_point, geom_abline, theme, element_text, ggsave\nfrom IPython.display import Image, display  # mostra a imagem no post\n\n# carrega variaveis do arquivo .env\nload_dotenv(find_dotenv())\n\nURLX = os.getenv(\"URL_X\")\nURLY = os.getenv(\"URL_Y\")\n\n\ndef carregardados(urlx: str, urly: str):\n    # carrega vetores x e y dos arquivos\n\n    if not urlx or not urly:\n        raise ValueError(\"urlx ou urly invalido\")\n\n    # limpa espacos e aspas\n    urlx = urlx.strip().strip('\"').strip(\"'\")\n    urly = urly.strip().strip('\"').strip(\"'\")\n\n    # se arquivo local, abre direto\n    if os.path.isfile(urlx):\n        with open(urlx, \"r\", encoding=\"utf-8\") as f:\n            x = np.loadtxt(StringIO(f.read()))\n    else:\n        resp_x = requests.get(urlx)\n        resp_x.raise_for_status()\n        x = np.loadtxt(StringIO(resp_x.text))\n\n    if os.path.isfile(urly):\n        with open(urly, \"r\", encoding=\"utf-8\") as f:\n            y = np.loadtxt(StringIO(f.read()))\n    else:\n        resp_y = requests.get(urly)\n        resp_y.raise_for_status()\n        y = np.loadtxt(StringIO(resp_y.text))\n\n    x = np.asarray(x).ravel()\n    y = np.asarray(y).ravel()\n\n    if x.shape[0] != y.shape[0]:\n        raise ValueError(\"tamanhos diferentes entre x e y\")\n\n    return x, y\n\n\ndef regressaomatriz(x: np.ndarray, y: np.ndarray):\n    # calcula coeficientes da regressao linear\n\n    X = np.column_stack((np.ones_like(x), x))\n\n    XtX = X.T @ X\n    XtX_inv = np.linalg.inv(XtX)\n    Xty = X.T @ y\n    beta = XtX_inv @ Xty\n\n    a = float(beta[0])  # intercepto\n    b = float(beta[1])  # inclinacao\n\n    return a, b\n\n\ndef fazgrafico(\n    x: np.ndarray,\n    y: np.ndarray,\n    a: float,\n    b: float,\n    nome_arquivo: str = \"grafico_regressao.png\",\n):\n    # monta o grafico com pontos e a reta de regressao\n\n    df = pd.DataFrame({\"x\": x, \"y\": y})\n\n    plot = (\n        ggplot(df, aes(\"x\", \"y\"))\n        + geom_point()\n        + geom_abline(intercept=a, slope=b)\n        + theme(\n            axis_title_x=element_text(size=12),\n            axis_title_y=element_text(size=12),\n            figure_size=(6, 4),\n        )\n    )\n\n    # salva imagem\n    ggsave(plot, filename=nome_arquivo, dpi=300)\n\n    return plot\n\n\ndef f(url_x: str | None = None, url_y: str | None = None):\n    # fluxo principal do codigo\n\n    if url_x is None:\n        url_x = URLX\n    if url_y is None:\n        url_y = URLY\n\n    x, y = carregardados(url_x, url_y)\n    a, b = regressaomatriz(x, y)\n\n    print(f\"intercepto (a): {a}\")\n    print(f\"inclinacao (b): {b}\")\n\n    plot = fazgrafico(x, y, a, b)\n    print(\"grafico salvo em grafico_regressao.png\")\n\n    return a, b, plot\n\n\n# executa o fluxo principal\na, b, plot = f()\n\n# exibe a imagem no post\ndisplay(Image(\"grafico_regressao.png\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nintercepto (a): 373.93446839132355\ninclinacao (b): 991.6278332981952\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n/home/codespace/.python/current/lib/python3.12/site-packages/plotnine/ggplot.py:623: PlotnineWarning: Saving 6 x 4 in image.\n/home/codespace/.python/current/lib/python3.12/site-packages/plotnine/ggplot.py:624: PlotnineWarning: Filename: grafico_regressao.png\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\ngrafico salvo em grafico_regressao.png\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](regressao_files/figure-html/cell-2-output-4.png){}\n:::\n:::\n\n\n",
    "supporting": [
      "regressao_files"
    ],
    "filters": [],
    "includes": {}
  }
}