{
  "hash": "71b18dac48821d1a4b10bbedcab2d2b2",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Cotação do Dólar por Período\"\ndescription: \"Consulta à API PTAX do Banco Central e geração de gráfico interativo\"\ndate: \"2025-02-01\"\nformat:\n  html:\n    code-fold: false\njupyter: python3\n---\n\nimport os\nimport calendar\nfrom datetime import datetime\n\nimport requests\nimport pandas as pd\nimport plotly.express as px\nfrom dotenv import load_dotenv\n\nload_dotenv()\n\nBCB_API = os.getenv(\n    \"BCB_API\",\n    \"https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata\"\n)\n\nBCB_DOLAR_ENDPOINT = os.getenv(\n    \"BCB_DOLAR_ENDPOINT\",\n    \"CotacaoDolarPeriodo(dataInicial=@dataInicial,dataFinalCotacao=@dataFinalCotacao)\"\n)\n\nMES_ANO = os.getenv(\"DOLAS_MES_ANO\", \"082021\")\n\n\ndef datas_mes(mmyyyy: str):\n    primeiro = datetime.strptime(mmyyyy, \"%m%Y\")\n    ultimodia = calendar.monthrange(primeiro.year, primeiro.month)[1]\n    ultimo = primeiro.replace(day=ultimodia)\n    return primeiro, ultimo\n\n\ndef dolardados(mmyyyy: str):\n    inicio, fim = datas_mes(mmyyyy)\n\n    url = (\n        f\"{BCB_API}/\"\n        f\"{BCB_DOLAR_ENDPOINT}?\"\n        f\"@dataInicial='{inicio.strftime('%m-%d-%Y')}'&\"\n        f\"@dataFinalCotacao='{fim.strftime('%m-%d-%Y')}'&\"\n        \"$top=10000&$format=json\"\n    )\n\n    resposta = requests.get(url)\n    resposta.raise_for_status()\n    return resposta.json()[\"value\"]\n\n\ndef organizardados(dados, mmyyyy: str):\n    df = pd.DataFrame(dados)\n    df[\"data\"] = pd.to_datetime(df[\"dataHoraCotacao\"]).dt.date\n    df = df[[\"data\", \"cotacaoVenda\"]].sort_values(\"data\")\n\n    inicio, fim = datas_mes(mmyyyy)\n    calendario = pd.date_range(start=inicio, end=fim).date\n    df_full = pd.DataFrame({\"data\": calendario})\n\n    df_full = df_full.merge(df, on=\"data\", how=\"left\")\n    df_full[\"cotacaoVenda\"] = df_full[\"cotacaoVenda\"].ffill()\n\n    return df_full\n\n\ndef plot(df: pd.DataFrame, mmyyyy: str):\n    titulo = f\"Cotação do Dólar – {mmyyyy[:2]}/{mmyyyy[2:]}\"\n    fig = px.line(df, x=\"data\", y=\"cotacaoVenda\", title=titulo)\n    fig.update_layout(\n        xaxis_title=\"Data\",\n        yaxis_title=\"Cotação de venda (R$)\"\n    )\n    return fig\n\n\ndef f(mmyyyy: str | None = None):\n    if mmyyyy is None:\n        mmyyyy = MES_ANO\n\n    dados = dolardados(mmyyyy)\n    df_tratado = organizardados(dados, mmyyyy)\n    fig = plot(df_tratado, mmyyyy)\n\n    # IMPORTANTE: nada de fig.show()\n    # A ÚLTIMA LINHA da função deve retornar o fig para o Quarto renderizar.\n    return df_tratado, fig\n\n\n# Executa e deixa o gráfico como última expressão → Quarto renderiza\ndf_final, fig = f()\nfig\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [],
    "includes": {}
  }
}